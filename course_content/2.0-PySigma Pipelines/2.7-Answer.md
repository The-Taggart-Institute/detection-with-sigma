# 2.7 :: Answers

```yaml
# Global win eventlog index
transformations:
    - id: index_condition
      type: add_condition
      conditions:
        index: winevent
      rule_conditions:
        - type: logsource
          product: windows

postprocessing:
    - id: ps_script_post_processing # CRITICAL severity, runs every 5 minutes with 10 minute lookback
      type: template
      template: |+
            [{{ rule.title }}]
            search = {{ query }} | eval rule_id="{{ rule.id }}", title="{{ rule.title }}", severity="{{rule.level}}"  | collect index=notable_events
            description = "{{ rule.description | replace('\n', ' ') }}"
            cron_schedule = */5 * * * *
            dispatch.earliest_time = -10m
            alert.severity = 6
      rule_conditions:
        - type: rule_attribute
          attribute: level
          value: critical
    - id: driver_load_post_processing # HIGH severity, runs every 30 minutes with 1 hour lookback
      type: template
      template: |+
            [{{ rule.title }}]
            search = {{ query }} | eval rule_id="{{ rule.id }}", title="{{ rule.title }}", severity="{{rule.level}}" | collect index=notable_events
            description = "{{ rule.description | replace('\n', ' ') }}"
            cron_schedule = */30 * * * *
            dispatch.earliest_time = -1h
            alert.severity = 5
      rule_conditions:
        - type: rule_attribute
          attribute: level
          value: high
    - id: dns_query_post_processing # MEDIUM severity, runs every 60 minutes with 2 hour lookback
      type: template
      template: |+
            [{{ rule.title }}]
            search = {{ query }} | eval rule_id="{{ rule.id }}", title="{{ rule.title }}", severity="{{rule.level}}"  | collect index=notable_events
            description = "{{ rule.description | replace('\n', ' ') }}"
            cron_schedule = */30 * * * *
            dispatch.earliest_time = -2h
            alert.severity = 4
      rule_conditions:
        - type: rule_attribute
          attribute: level
          value: medium
    - id: file_event_post_processing # LOW severity, uses default values for cron and dispatch, suppress on hostname, filename, action for 24h
      type: template
      template: |+
            [{{ rule.title }}]
            search = {{ query }} | eval rule_id="{{ rule.id }}", title="{{ rule.title }}", severity="{{rule.level}}"  | collect index=notable_events
            description = "{{ rule.description | replace('\n', ' ') }}"
            cron_schedule = 0 0 * * *
            dispatch.earliest_time = -2h
            alert.severity = 3
      rule_conditions:
        - type: rule_attribute
          attribute: level
          value: low

finalizers:
    - type: concat
      prefix: |
            [default]
            dispatch.latest_time = now
            enableSched = 1
            allow_skew = 5m
```

Output:
```
[default]
dispatch.latest_time = now
enableSched = 1
allow_skew = 5m
[AppX Package Installation Attempts Via AppInstaller.EXE]
search = index="winevent" Image="C:\\Program Files\\WindowsApps\\Microsoft.DesktopAppInstaller_*" Image="*\\AppInstaller.exe" | eval rule_id="7cff77e1-9663-46a3-8260-17f2e1aa9d0a", title="AppX Package Installation Attempts Via AppInstaller.EXE", severity="medium"  | collect index=notable_events
description = "Detects DNS queries made by "AppInstaller.EXE". The AppInstaller is the default handler for the "ms-appinstaller" URI. It attempts to load/install a package from the referenced URL "
cron_schedule = */30 * * * *
dispatch.earliest_time = -2h
alert.severity = 4
[Vulnerable WinRing0 Driver Load]
search = index="winevent" ImageLoaded IN ("*\\WinRing0x64.sys", "*\\WinRing0.sys", "*\\WinRing0.dll", "*\\WinRing0x64.dll", "*\\winring00x64.sys") OR Hashes="*IMPHASH=D41FA95D4642DC981F10DE36F4DC8CD7*" OR Imphash="d41fa95d4642dc981f10de36f4dc8cd7" | eval rule_id="1a42dfa6-6cb2-4df9-9b48-295be477e835", title="Vulnerable WinRing0 Driver Load", severity="high" | collect index=notable_events
description = "Detects the load of a signed WinRing0 driver often used by threat actors, crypto miners (XMRIG) or malware for privilege escalation"
cron_schedule = */30 * * * *
dispatch.earliest_time = -1h
alert.severity = 5
[Advanced IP Scanner - File Event]
search = index="winevent" TargetFilename="*\\AppData\\Local\\Temp\\Advanced IP Scanner 2*" | eval rule_id="fed85bf9-e075-4280-9159-fbe8a023d6fa", title="Advanced IP Scanner - File Event", severity="low"  | collect index=notable_events
description = "Detects the use of Advanced IP Scanner. Seems to be a popular tool for ransomware groups."
cron_schedule = 0 0 * * *
dispatch.earliest_time = -2h
alert.severity = 3
[Silence.EDA Detection]
search = index="winevent" ScriptBlockText="*System.Diagnostics.Process*" ScriptBlockText="*Stop-Computer*" ScriptBlockText="*Restart-Computer*" ScriptBlockText="*Exception in execution*" ScriptBlockText="*$cmdargs*" ScriptBlockText="*Close-Dnscat2Tunnel*" ScriptBlockText="*set type=$LookupType`nserver*" ScriptBlockText="*$Command | nslookup 2>&1 | Out-String*" ScriptBlockText="*New-RandomDNSField*" ScriptBlockText="*[Convert]::ToString($SYNOptions, 16)*" ScriptBlockText="*$Session.Dead = $True*" ScriptBlockText="*$Session[\"Driver\"] -eq*" | eval rule_id="3ceb2083-a27f-449a-be33-14ec1b7cc973", title="Silence.EDA Detection", severity="critical"  | collect index=notable_events
description = "Detects Silence EmpireDNSAgent as described in the Group-IP report"
cron_schedule = */5 * * * *
dispatch.earliest_time = -10m
alert.severity = 6
```
